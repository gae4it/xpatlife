---
// Component for displaying PWA installation prompt
// Compatible with Android (Chrome, Firefox, Edge) and iOS (Safari 16.4+)
// No external dependencies required - lightweight
import { Icon } from 'astro-icon/components';
---

<div id="install-prompt-container" class="py-4">
  <!-- iOS Instructions (shown for Safari on iOS) -->
  <div
    id="ios-instructions"
    class="hidden bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-6 mb-6"
  >
    <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-100 mb-3 flex items-center gap-2">
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M17.05 13.5c-.91 0-1.82-.33-2.5-1.02C13.36 11.56 12 9.77 12 7.5s1.36-4.06 2.55-5.03c.68-.69 1.59-1.02 2.5-1.02s1.82.33 2.5 1.02c1.19.97 2.55 2.76 2.55 5.03s-1.36 4.06-2.55 5.03c-.68.69-1.59 1.02-2.5 1.02m0-11c-.41 0-.82.12-1.19.38-.92.74-1.86 2.42-1.86 4.62s.94 3.88 1.86 4.62c.37.26.78.38 1.19.38s.82-.12 1.19-.38c.92-.74 1.86-2.42 1.86-4.62s-.94-3.88-1.86-4.62c-.37-.26-.78-.38-1.19-.38z"
        ></path>
      </svg>
      Install xPatLife App on iOS
    </h3>
    <ol class="text-blue-800 dark:text-blue-200 space-y-2 text-sm">
      <li><strong>1.</strong> Tap the <strong>Share</strong> button (square with arrow)</li>
      <li><strong>2.</strong> Scroll down and tap <strong>"Add to Home Screen"</strong></li>
      <li><strong>3.</strong> Confirm the app name and tap <strong>"Add"</strong></li>
    </ol>
  </div>

  <!-- Install Button (shown when beforeinstallprompt fires) -->
  <div id="install-container" class="hidden text-center max-w-3xl mx-auto">
    <p class="text-lg text-muted dark:text-slate-400 mb-8">
      Install xPatLife on your home screen for quick access whenever you need it
    </p>
    <div class="flex justify-center">
      <button
        id="install-button"
        class="inline-flex items-center justify-center rounded-full border border-[#0154CF] bg-white font-semibold text-center text-base text-[#0154CF] leading-snug transition py-3.5 px-8 ease-in duration-200 hover:bg-blue-50 dark:bg-white dark:text-[#0154CF] dark:border-[#0154CF] dark:hover:bg-gray-300"
      >
        <span class="flex items-center gap-2">
          <Icon name="tabler:download" class="w-5 h-5" />
          Install App
        </span>
      </button>
    </div>
  </div>
</div>

<script>
  interface BeforeInstallPromptEvent extends Event {
    prompt: () => Promise<void>;
    userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>;
  }

  let deferredPrompt: BeforeInstallPromptEvent | null = null;
  const isIOS =
    /iPad|iPhone|iPod/.test(navigator.userAgent) && !(window as unknown as Record<string, unknown>).MSStream;
  const iosInstructionsEl = document.getElementById('ios-instructions');
  const installButton = document.getElementById('install-button');
  const installContainer = document.getElementById('install-container');

  // Register Service Worker immediately (required for PWA on Android)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker
      .register('/sw.js')
      .then((registration) => {
        console.log('Service Worker registered:', registration);
      })
      .catch((error) => {
        console.log('Service Worker registration failed:', error);
      });
  }

  // Listen for the beforeinstallprompt event (Android/Chromium browsers)
  window.addEventListener('beforeinstallprompt', (e: Event) => {
    e.preventDefault();
    deferredPrompt = e as BeforeInstallPromptEvent;
    console.log('beforeinstallprompt event fired - app is installable!');
    
    // Show the install button container
    installContainer?.classList.remove('hidden');
  });

  // Handle install button click
  installButton?.addEventListener('click', async () => {
    if (!deferredPrompt) {
      console.log('No deferred prompt available');
      return;
    }

    try {
      // Trigger the native install prompt
      await deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`User response: ${outcome}`);
      
      deferredPrompt = null;
      
      // Hide the button after user makes a choice
      installContainer?.classList.add('hidden');
    } catch (error) {
      console.error('Error showing install prompt:', error);
    }
  });

  // Handle app installed event
  window.addEventListener('appinstalled', () => {
    console.log('PWA was installed successfully!');
    deferredPrompt = null;
    installContainer?.classList.add('hidden');
  });

  // Show iOS instructions if on iOS
  if (isIOS) {
    iosInstructionsEl?.classList.remove('hidden');
  }
</script>
